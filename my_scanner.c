/*
  A kernel module to list process by their names. Print when loading the module.
  In the terminal, compile this module with "make" and load it with "sudo insmod process.ko". 
  Check the result of printk by “dmesg”
  Unload it with "sudo rmmod process.ko".
*/

#include <linux/kernel.h>
#include <linux/module.h>
#include <linux/init.h>
#include <linux/sched.h> // task_struct definition
#include <asm/unistd.h>
#include <linux/list.h>
#include <linux/init_task.h>
#include "print_to_tty.c"

#ifndef __KERNEL__
#define __KERNEL__
#endif

// Print all running processes with their names
static void print_task_by_name(char *str) {

  // The struct used for info of a process
  struct task_struct* task;
  
  // Go over through the list of processes
  for_each_process(task) {
    if (!(strcmp((task->comm), str))) {
      printk("Current process: %s, PID: %d\n", task->comm, task->pid);
      print_string("Found string");
    }
  }

  return;
}

// Initialization of module
static int __init init_MalwareModule(void)
{
  char name[] = "gedit";
  
  print_string("The module has been inserted.  Hello world!");
  
  printk(KERN_INFO "Malware Scanner Kernal Module Init.\n");
  
  print_task_by_name(name);
  return 0;
}

// Exit of module
static void __exit exit_MalwareModule(void)
{
  printk(KERN_INFO "Malware Scanner Kernal Module Exit.\n");
  return;
}

module_init(init_MalwareModule);
module_exit(exit_MalwareModule);

MODULE_AUTHOR("Jared Frees, Troy Ellison");
MODULE_LICENSE("GPL v2");
MODULE_DESCRIPTION("A kernel module to list process by their names");
MODULE_VERSION("0.1");


