#define SYS_CALL_TABLE "sys_call_table"
#define SYSCALL_NI __NR_tuxcall

static ulong *syscall_table = NULL;

static void *original_syscall = NULL;

//static char buffer[40];

/*
static unsigned long lkm_syscall(const char *string)
{
        if (copy_from_user(buffer, string, 40)) {
                return -EFAULT;
        }
        buffer[39] = 0;
        printk("Input address %s\n", buffer);
        return 0;
}
*/

static int is_syscall_table(ulong *p)
{
        return ((p != NULL) && (p[__NR_close] == (ulong)sys_close));
}

static void replace_syscall(ulong offset, ulong func_address)
{

        syscall_table = (ulong *)kallsyms_lookup_name(SYS_CALL_TABLE);
        if (is_syscall_table(syscall_table)) {

                printk(KERN_INFO "Syscall table address : %p\n", syscall_table);
                original_syscall = (void *)(syscall_table[offset]);
                printk(KERN_INFO "Syscall at offset %lu : %p\n", offset, original_syscall);
                printk(KERN_INFO "Custom syscall address %p\n", func_address);
                syscall_table[offset] = func_address;
                printk(KERN_INFO "Syscall hijacked\n");
                printk(KERN_INFO "Syscall at offset %lu : %p\n", offset, (void *)syscall_table[offset]);
        }
}

